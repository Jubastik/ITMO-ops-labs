# Оглавление

1. Краткое описание
2. Проекты  
   2.1 Описание  
   2.2 Ручной запуск

3. Nginx  
   3.1 Описание  
   3.2 nginx.conf  
   3.3 https

4. Запуск
5. Используемые ресурсы

## 1. Краткое описание

Для решения лабораторной работы были созданы два простейших FastApi веб приложения.  
Для обеспечения доступа к ним был использован Nginx в роли реверс прокси.  
Nginx и FastApi были запущены в контейнерах Docker. Для одновременного запуска используется docker-compose.

## 2. Проекты

### 2.1 Описание

Создано два FastApi приложения.

- app1 - простейшее приложение, которое возвращает строку "Hello from app №1".
- app2 - простейшее приложение, которое возвращает строку "Hello from app №2".

Зависимости прописаны в requirements.txt.  
Запуск происходит с помощью ASGI сервера uvicorn.  
Для удобства приложения были контейнезированны. Контейнеры специально созданы
с нарушением Best Practice, для дальнейшего выполнения Лабораторной работы №2.

### 2.2 Ручной запуск

Без использования Docker:

```bash
pip install -r requirements.txt
uvicorn main:app --reload
```

С использованием Docker:

```bash
cd app1
docker build -f DockerfileHorrible -t app1 .
docker run -p 7001:7001 app1
```

Для app2 используется порт 7002. Остальное аналогично.

## 3. Nginx

### 3.1 Описание

Для запуска Nginx используется контейнер на базе официального образа. Конфигурация копируется из файла nginx.conf.
Стартовая страница находится в папке html. Ключи генерируются локально и копруются в контейнер на этапе сборки.

### 3.2 nginx.conf

Конфигурация была написана с нуля. Сервер слушающий 80 порт возвращает редирект на 443. Тем самым обеспечивается
принудительное использование https.

Существует два location:

- Первый location обрабатывает запросы к /app1 и перенаправляет их на http://app1:7001.
- Второй location обрабатывает запросы к /app2 и перенаправляет их на http://app2:7002.
  app1 и app2 - адреса приложений в сети созданной Docker-compose. Приложения извне недоступны

### 3.3 https

Для обеспечения https было решено использовать самоподписанный сертификат. Сертификат создается на этапе настройки
следующим образом:

_nginx.crt и nginx.key обязательно должны быть перегенерированы. Они добавлены в репозиторий исключительно для удобства
проверки_

```bash
cd nginx
openssl genpkey -algorithm RSA -out nginx.key -pkeyopt rsa_keygen_bits:2048
openssl req -new -x509 -key nginx.key -out nginx.crt -days 365
```

- openssl - утилита для работы с TLS/SSl
- genpkey - создание закрытого ключа
- algorithm - используемый алгоритм
- out - файл для записи ключа
- pkeyopt - опции для создания ключа. Я указал длинну ключа 2048


- req - создание запроса на сертификат
- new - создание нового запроса
- x509 - формат сертификата. Указывает, что сертификат будет самоподписанным
- key - указание используемого закрытого ключа
- out - файл для записи сертификата
- days - срок действия сертификата

## 4 Запуск

Для запуска используется docker-compose.

```bash 
docker-compose up
```

После запуска можно обратиться к https://localhost и увидеть стартовую страницу.
По /app1 и /app2 будут доступны приложения.
http://localhost вызовет редирект на https://localhost.

alias в лабораторной работе не используется, так как nginx используется как реверс прокси, а не в режиме статик сервера.

## 5. Используемые ресурсы

- https://www.youtube.com/watch?v=9t9Mp0BGnyI
- https://habr.com/ru/companies/mvideo/articles/751506/

